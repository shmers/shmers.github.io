<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Incorporating Geospatial Context into Risk Modelling – Morris Jones</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Morris Jones</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/shmers"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../assets/Morris_Jones_CV.pdf"> 
<span class="menu-text">CV</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#problem-statement" id="toc-problem-statement" class="nav-link" data-scroll-target="#problem-statement">Problem Statement</a></li>
  <li><a href="#synthetic-spatial-data" id="toc-synthetic-spatial-data" class="nav-link" data-scroll-target="#synthetic-spatial-data">Synthetic Spatial Data</a></li>
  <li><a href="#create-spatial-clusters-of-higher-risk" id="toc-create-spatial-clusters-of-higher-risk" class="nav-link" data-scroll-target="#create-spatial-clusters-of-higher-risk">Create spatial clusters of higher risk</a></li>
  <li><a href="#event-generation" id="toc-event-generation" class="nav-link" data-scroll-target="#event-generation">Event Generation</a></li>
  <li><a href="#spatial-binning" id="toc-spatial-binning" class="nav-link" data-scroll-target="#spatial-binning">Spatial Binning</a></li>
  <li><a href="#spatial-aggregation" id="toc-spatial-aggregation" class="nav-link" data-scroll-target="#spatial-aggregation">Spatial Aggregation</a></li>
  <li><a href="#smoothing-sparse-spatial-estimates" id="toc-smoothing-sparse-spatial-estimates" class="nav-link" data-scroll-target="#smoothing-sparse-spatial-estimates">Smoothing Sparse Spatial Estimates</a></li>
  <li><a href="#constructing-geospatial-features" id="toc-constructing-geospatial-features" class="nav-link" data-scroll-target="#constructing-geospatial-features">Constructing Geospatial Features</a></li>
  <li><a href="#visualising-raw-spatial-events" id="toc-visualising-raw-spatial-events" class="nav-link" data-scroll-target="#visualising-raw-spatial-events">Visualising Raw Spatial Events</a></li>
  <li><a href="#visualising-smoothed-spatial-risk" id="toc-visualising-smoothed-spatial-risk" class="nav-link" data-scroll-target="#visualising-smoothed-spatial-risk">Visualising Smoothed Spatial Risk</a></li>
  <li><a href="#thiessen-voronoi-polygons-for-spatial-risk" id="toc-thiessen-voronoi-polygons-for-spatial-risk" class="nav-link" data-scroll-target="#thiessen-voronoi-polygons-for-spatial-risk">Thiessen (Voronoi) Polygons for Spatial Risk</a></li>
  <li><a href="#mapping-spatial-risk-using-the-british-national-grid" id="toc-mapping-spatial-risk-using-the-british-national-grid" class="nav-link" data-scroll-target="#mapping-spatial-risk-using-the-british-national-grid">Mapping Spatial Risk Using the British National Grid</a></li>
  <li><a href="#keep-only-great-britain-approximate-longitude-filter" id="toc-keep-only-great-britain-approximate-longitude-filter" class="nav-link" data-scroll-target="#keep-only-great-britain-approximate-longitude-filter">Keep only Great Britain (approximate longitude filter)</a></li>
  <li><a href="#wip---visualisation" id="toc-wip---visualisation" class="nav-link" data-scroll-target="#wip---visualisation">WIP - Visualisation</a></li>
  <li><a href="#reproject-to-bng" id="toc-reproject-to-bng" class="nav-link" data-scroll-target="#reproject-to-bng">Reproject to BNG</a></li>
  <li><a href="#load-population-csv" id="toc-load-population-csv" class="nav-link" data-scroll-target="#load-population-csv">Load population CSV</a></li>
  <li><a href="#extract-relevant-columns" id="toc-extract-relevant-columns" class="nav-link" data-scroll-target="#extract-relevant-columns">Extract relevant columns</a></li>
  <li><a href="#project-compute-population-density" id="toc-project-compute-population-density" class="nav-link" data-scroll-target="#project-compute-population-density">## Project &amp; Compute Population Density</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Incorporating Geospatial Context into Risk Modelling</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This project demonstrates how geospatial context can be incorporated into predictive risk models using aggregated, non‑identifying spatial features. The emphasis is on feature construction, spatial smoothing, and avoiding information leakage rather than on fine‑grained location data.</p>
<p>All data used in this project is synthetic or publicly available.</p>
<hr>
</section>
<section id="problem-statement" class="level2">
<h2 class="anchored" data-anchor-id="problem-statement">Problem Statement</h2>
<p>We consider a hypothetical risk prediction problem where event likelihood varies spatially due to underlying environmental, behavioural, or socio‑economic factors. The goal is to construct geospatial features that capture this variation in a stable and privacy‑preserving way.</p>
<p>Key challenges include:</p>
<ul>
<li>Spatial leakage</li>
<li>Sparsity in fine‑grained locations</li>
<li>Balancing resolution with robustness</li>
</ul>
<hr>
</section>
<section id="synthetic-spatial-data" class="level2">
<h2 class="anchored" data-anchor-id="synthetic-spatial-data">Synthetic Spatial Data</h2>
<div id="e8ca5eb0" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">123</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">20000</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Synthetic latitude / longitude (approximate UK bounding box)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>lat <span class="op">=</span> np.random.uniform(<span class="fl">50.0</span>, <span class="fl">55.5</span>, n)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>lon <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="fl">5.5</span>, <span class="fl">1.8</span>, n)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latitude"</span>: lat,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longitude"</span>: lon</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>df.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>53.830581</td>
<td>-4.868714</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>51.573766</td>
<td>-1.235600</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>51.247683</td>
<td>-2.048911</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>53.032231</td>
<td>-0.370855</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>53.957079</td>
<td>-2.130276</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="create-spatial-clusters-of-higher-risk" class="level2">
<h2 class="anchored" data-anchor-id="create-spatial-clusters-of-higher-risk">Create spatial clusters of higher risk</h2>
<div id="f950d667" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>risk_centers <span class="op">=</span> [</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">51.5</span>, <span class="op">-</span><span class="fl">0.1</span>),   <span class="co"># London</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">53.5</span>, <span class="op">-</span><span class="fl">2.3</span>),   <span class="co"># Manchester</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">52.5</span>, <span class="op">-</span><span class="fl">1.9</span>)    <span class="co"># Birmingham</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>risk <span class="op">=</span> np.zeros(n)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lat_c, lon_c <span class="kw">in</span> risk_centers:</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> np.sqrt((df[<span class="st">"latitude"</span>] <span class="op">-</span> lat_c)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (df[<span class="st">"longitude"</span>] <span class="op">-</span> lon_c)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    risk <span class="op">+=</span> np.exp(<span class="op">-</span>dist <span class="op">/</span> <span class="fl">0.5</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalise</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>risk <span class="op">=</span> risk <span class="op">/</span> risk.<span class="bu">max</span>()</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"spatial_risk"</span>] <span class="op">=</span> risk</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>df.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">spatial_risk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>53.830581</td>
<td>-4.868714</td>
<td>0.006423</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>51.573766</td>
<td>-1.235600</td>
<td>0.195246</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>51.247683</td>
<td>-2.048911</td>
<td>0.099452</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>53.032231</td>
<td>-0.370855</td>
<td>0.092219</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>53.957079</td>
<td>-2.130276</td>
<td>0.387473</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="event-generation" class="level2">
<h2 class="anchored" data-anchor-id="event-generation">Event Generation</h2>
<div id="a38e6920" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>logit <span class="op">=</span> <span class="op">-</span><span class="fl">4.0</span> <span class="op">+</span> <span class="fl">2.0</span> <span class="op">*</span> df[<span class="st">"spatial_risk"</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>prob <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span>logit))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"event"</span>] <span class="op">=</span> np.random.binomial(<span class="dv">1</span>, prob)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"event"</span>].mean()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>np.float64(0.02315)</code></pre>
</div>
</div>
<hr>
</section>
<section id="spatial-binning" class="level2">
<h2 class="anchored" data-anchor-id="spatial-binning">Spatial Binning</h2>
<p>To incorporate spatial context in a robust and privacy‑preserving way, we discretise latitude and longitude into coarse spatial bins. This reduces sensitivity to exact coordinates while enabling aggregation of local risk signals.</p>
<div id="5fd5d5f3" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define bin sizes (degrees)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>lat_bin_size <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>lon_bin_size <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"lat_bin"</span>] <span class="op">=</span> (df[<span class="st">"latitude"</span>] <span class="op">/</span> lat_bin_size).astype(<span class="bu">int</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"lon_bin"</span>] <span class="op">=</span> (df[<span class="st">"longitude"</span>] <span class="op">/</span> lon_bin_size).astype(<span class="bu">int</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into a single spatial cell identifier</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"spatial_cell"</span>] <span class="op">=</span> df[<span class="st">"lat_bin"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df[<span class="st">"lon_bin"</span>].astype(<span class="bu">str</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"latitude"</span>, <span class="st">"longitude"</span>, <span class="st">"spatial_cell"</span>]].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">spatial_cell</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>53.830581</td>
<td>-4.868714</td>
<td>215_-19</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>51.573766</td>
<td>-1.235600</td>
<td>206_-4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>51.247683</td>
<td>-2.048911</td>
<td>204_-8</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>53.032231</td>
<td>-0.370855</td>
<td>212_-1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>53.957079</td>
<td>-2.130276</td>
<td>215_-8</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="spatial-aggregation" class="level2">
<h2 class="anchored" data-anchor-id="spatial-aggregation">Spatial Aggregation</h2>
<p>Within each spatial cell, we compute aggregated statistics that summarise local event behaviour. These aggregates form the basis of geospatial risk features.</p>
<div id="a42b1521" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cell_stats <span class="op">=</span> (</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    df.groupby(<span class="st">"spatial_cell"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>      .agg(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>          cell_event_rate<span class="op">=</span>(<span class="st">"event"</span>, <span class="st">"mean"</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>          cell_event_count<span class="op">=</span>(<span class="st">"event"</span>, <span class="st">"sum"</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>          cell_exposure<span class="op">=</span>(<span class="st">"event"</span>, <span class="st">"count"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      .reset_index()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>cell_stats.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">spatial_cell</th>
<th data-quarto-table-cell-role="th">cell_event_rate</th>
<th data-quarto-table-cell-role="th">cell_event_count</th>
<th data-quarto-table-cell-role="th">cell_exposure</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>200_-1</td>
<td>0.030303</td>
<td>1</td>
<td>33</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>200_-10</td>
<td>0.000000</td>
<td>0</td>
<td>39</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>200_-11</td>
<td>0.041667</td>
<td>1</td>
<td>24</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>200_-12</td>
<td>0.000000</td>
<td>0</td>
<td>39</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>200_-13</td>
<td>0.055556</td>
<td>2</td>
<td>36</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="smoothing-sparse-spatial-estimates" class="level2">
<h2 class="anchored" data-anchor-id="smoothing-sparse-spatial-estimates">Smoothing Sparse Spatial Estimates</h2>
<p>Raw cell event rates can be <strong>noisy</strong> when exposure is low.<br>
We’ll apply <strong>empirical Bayes–style smoothing</strong>.</p>
<p>To reduce variance in low‑exposure cells, we apply simple Bayesian smoothing by shrinking cell‑level event rates toward the global mean.</p>
<div id="e20f31af" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Global event rate</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>global_rate <span class="op">=</span> df[<span class="st">"event"</span>].mean()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Smoothing strength (pseudo-counts)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>cell_stats[<span class="st">"smoothed_event_rate"</span>] <span class="op">=</span> (</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    (cell_stats[<span class="st">"cell_event_rate"</span>] <span class="op">*</span> cell_stats[<span class="st">"cell_exposure"</span>] <span class="op">+</span> alpha <span class="op">*</span> global_rate)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> (cell_stats[<span class="st">"cell_exposure"</span>] <span class="op">+</span> alpha)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>cell_stats.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">spatial_cell</th>
<th data-quarto-table-cell-role="th">cell_event_rate</th>
<th data-quarto-table-cell-role="th">cell_event_count</th>
<th data-quarto-table-cell-role="th">cell_exposure</th>
<th data-quarto-table-cell-role="th">smoothed_event_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>200_-1</td>
<td>0.030303</td>
<td>1</td>
<td>33</td>
<td>0.025994</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>200_-10</td>
<td>0.000000</td>
<td>0</td>
<td>39</td>
<td>0.013006</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>200_-11</td>
<td>0.041667</td>
<td>1</td>
<td>24</td>
<td>0.029155</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>200_-12</td>
<td>0.000000</td>
<td>0</td>
<td>39</td>
<td>0.013006</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>200_-13</td>
<td>0.055556</td>
<td>2</td>
<td>36</td>
<td>0.036715</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="constructing-geospatial-features" class="level2">
<h2 class="anchored" data-anchor-id="constructing-geospatial-features">Constructing Geospatial Features</h2>
<p>We attach the aggregated spatial features back to the individual‑level dataset for use in downstream modelling.</p>
<div id="9f0124bc" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.merge(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    cell_stats[[<span class="st">"spatial_cell"</span>, <span class="st">"smoothed_event_rate"</span>]],</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"spatial_cell"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"latitude"</span>, <span class="st">"longitude"</span>, <span class="st">"smoothed_event_rate"</span>]].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">smoothed_event_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>53.830581</td>
<td>-4.868714</td>
<td>0.014652</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>51.573766</td>
<td>-1.235600</td>
<td>0.027660</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>51.247683</td>
<td>-2.048911</td>
<td>0.041006</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>53.032231</td>
<td>-0.370855</td>
<td>0.028019</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>53.957079</td>
<td>-2.130276</td>
<td>0.028388</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
<div id="47accc18" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>geometry <span class="op">=</span> [</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    Point(lon, lat)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lon, lat <span class="kw">in</span> <span class="bu">zip</span>(df[<span class="st">"longitude"</span>], df[<span class="st">"latitude"</span>])</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gpd.GeoDataFrame(df, geometry<span class="op">=</span>geometry, crs<span class="op">=</span><span class="st">"EPSG:4326"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>gdf_bng <span class="op">=</span> gdf.to_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="visualising-raw-spatial-events" class="level2">
<h2 class="anchored" data-anchor-id="visualising-raw-spatial-events">Visualising Raw Spatial Events</h2>
<p>We begin by visualising the spatial distribution of events to understand broad geographic patterns and clustering behaviour.</p>
<div id="9d1e31d8" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>plt.scatter(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"longitude"</span>],</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"latitude"</span>],</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    c<span class="op">=</span>df[<span class="st">"event"</span>],</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"coolwarm"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">10</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Longitude"</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Latitude"</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Spatial Distribution of Events"</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>plt.colorbar(label<span class="op">=</span><span class="st">"Event indicator"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="geospatial-risk_files/figure-html/cell-10-output-1.png" width="581" height="597" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="visualising-smoothed-spatial-risk" class="level2">
<h2 class="anchored" data-anchor-id="visualising-smoothed-spatial-risk">Visualising Smoothed Spatial Risk</h2>
<p>Aggregated and smoothed spatial features provide a clearer view of underlying geographic risk patterns.</p>
<div id="a4e4219d" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use cell-level centroids for plotting</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>cell_stats[<span class="st">"lat_center"</span>] <span class="op">=</span> (</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    cell_stats[<span class="st">"spatial_cell"</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.split(<span class="st">"_"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    .astype(<span class="bu">int</span>) <span class="op">*</span> lat_bin_size</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>cell_stats[<span class="st">"lon_center"</span>] <span class="op">=</span> (</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    cell_stats[<span class="st">"spatial_cell"</span>]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.split(<span class="st">"_"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>[<span class="dv">1</span>]</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    .astype(<span class="bu">int</span>) <span class="op">*</span> lon_bin_size</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>plt.scatter(</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    cell_stats[<span class="st">"lon_center"</span>],</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    cell_stats[<span class="st">"lat_center"</span>],</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    c<span class="op">=</span>cell_stats[<span class="st">"smoothed_event_rate"</span>],</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"viridis"</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span>cell_stats[<span class="st">"cell_exposure"</span>] <span class="op">/</span> <span class="dv">5</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Longitude"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Latitude"</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Smoothed Spatial Risk by Grid Cell"</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>plt.colorbar(label<span class="op">=</span><span class="st">"Smoothed event rate"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="geospatial-risk_files/figure-html/cell-11-output-1.png" width="590" height="597" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Comparing individual‑level and aggregated spatial visualisations highlights the trade‑off between noise and signal. While raw location data is highly variable, spatial aggregation and smoothing reveal stable geographic patterns suitable for use in predictive models.</p>
<hr>
</section>
<section id="thiessen-voronoi-polygons-for-spatial-risk" class="level2">
<h2 class="anchored" data-anchor-id="thiessen-voronoi-polygons-for-spatial-risk">Thiessen (Voronoi) Polygons for Spatial Risk</h2>
<p>To further visualise spatial structure, we construct Thiessen (Voronoi) polygons based on spatial cell centroids. Each polygon represents the region of space closest to a given cell, providing a continuous spatial partition coloured by smoothed risk.</p>
<p>For the curious, click here to learn more about <a href="https://en.wikipedia.org/wiki/Voronoi_diagram">Voronoi polygons</a></p>
<div id="be9598de" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial <span class="im">import</span> Voronoi</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare centroid coordinates</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> np.column_stack([</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    cell_stats[<span class="st">"lon_center"</span>].values,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    cell_stats[<span class="st">"lat_center"</span>].values</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute Voronoi tessellation</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>vor <span class="op">=</span> Voronoi(points)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Voronoi regions</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> region_index, region <span class="kw">in</span> <span class="bu">enumerate</span>(vor.regions):</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> region <span class="kw">or</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">in</span> region:</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span>  <span class="co"># Skip infinite regions</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    polygon <span class="op">=</span> [vor.vertices[i] <span class="cf">for</span> i <span class="kw">in</span> region]</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    polygon <span class="op">=</span> np.array(polygon)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find corresponding point index</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    point_indices <span class="op">=</span> np.where(vor.point_region <span class="op">==</span> region_index)[<span class="dv">0</span>]</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(point_indices) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> point_indices[<span class="dv">0</span>]</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    risk_value <span class="op">=</span> cell_stats.iloc[idx][<span class="st">"smoothed_event_rate"</span>]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    plt.fill(</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        polygon[:, <span class="dv">0</span>],</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        polygon[:, <span class="dv">1</span>],</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>plt.cm.viridis(risk_value <span class="op">/</span> cell_stats[<span class="st">"smoothed_event_rate"</span>].<span class="bu">max</span>()),</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay centroids</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>plt.scatter(</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    cell_stats[<span class="st">"lon_center"</span>],</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    cell_stats[<span class="st">"lat_center"</span>],</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    c<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.6</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Longitude"</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Latitude"</span>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Thiessen (Voronoi) Polygons Coloured by Smoothed Risk"</span>)</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="geospatial-risk_files/figure-html/cell-12-output-1.png" width="659" height="671" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="mapping-spatial-risk-using-the-british-national-grid" class="level2">
<h2 class="anchored" data-anchor-id="mapping-spatial-risk-using-the-british-national-grid">Mapping Spatial Risk Using the British National Grid</h2>
<p>To visualise spatial risk in a cartographically appropriate coordinate system, we project locations onto the British National Grid (BNG). This projection is commonly used for mapping and spatial analysis within Great Britain, providing distance‑preserving coordinates in metres.</p>
<p>Northern Ireland uses a separate national grid and is therefore excluded from this visualisation for technical correctness.</p>
<div id="f4eb0f1e" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Natural Earth country boundaries (110m resolution)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://naturalearth.s3.amazonaws.com/110m_cultural/ne_110m_admin_0_countries.zip"</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>world <span class="op">=</span> gpd.read_file(url)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract United Kingdom</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>uk <span class="op">=</span> world[world[<span class="st">"NAME"</span>] <span class="op">==</span> <span class="st">"United Kingdom"</span>]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>uk</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">featurecla</th>
<th data-quarto-table-cell-role="th">scalerank</th>
<th data-quarto-table-cell-role="th">LABELRANK</th>
<th data-quarto-table-cell-role="th">SOVEREIGNT</th>
<th data-quarto-table-cell-role="th">SOV_A3</th>
<th data-quarto-table-cell-role="th">ADM0_DIF</th>
<th data-quarto-table-cell-role="th">LEVEL</th>
<th data-quarto-table-cell-role="th">TYPE</th>
<th data-quarto-table-cell-role="th">TLC</th>
<th data-quarto-table-cell-role="th">ADMIN</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">FCLASS_TR</th>
<th data-quarto-table-cell-role="th">FCLASS_ID</th>
<th data-quarto-table-cell-role="th">FCLASS_PL</th>
<th data-quarto-table-cell-role="th">FCLASS_GR</th>
<th data-quarto-table-cell-role="th">FCLASS_IT</th>
<th data-quarto-table-cell-role="th">FCLASS_NL</th>
<th data-quarto-table-cell-role="th">FCLASS_SE</th>
<th data-quarto-table-cell-role="th">FCLASS_BD</th>
<th data-quarto-table-cell-role="th">FCLASS_UA</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">143</th>
<td>Admin-0 country</td>
<td>1</td>
<td>2</td>
<td>United Kingdom</td>
<td>GB1</td>
<td>1</td>
<td>2</td>
<td>Country</td>
<td>1</td>
<td>United Kingdom</td>
<td>...</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>MULTIPOLYGON (((-6.19788 53.86757, -6.95373 54...</td>
</tr>
</tbody>
</table>

<p>1 rows × 169 columns</p>
</div>
</div>
</div>
<hr>
<div id="a9a26688" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert point data to GeoDataFrame</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>geometry <span class="op">=</span> [</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    Point(lon, lat)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lon, lat <span class="kw">in</span> <span class="bu">zip</span>(df[<span class="st">"longitude"</span>], df[<span class="st">"latitude"</span>])</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gpd.GeoDataFrame(df, geometry<span class="op">=</span>geometry, crs<span class="op">=</span><span class="st">"EPSG:4326"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject to British National Grid (EPSG:27700)</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>uk_bng <span class="op">=</span> uk.to_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>uk_bng</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">featurecla</th>
<th data-quarto-table-cell-role="th">scalerank</th>
<th data-quarto-table-cell-role="th">LABELRANK</th>
<th data-quarto-table-cell-role="th">SOVEREIGNT</th>
<th data-quarto-table-cell-role="th">SOV_A3</th>
<th data-quarto-table-cell-role="th">ADM0_DIF</th>
<th data-quarto-table-cell-role="th">LEVEL</th>
<th data-quarto-table-cell-role="th">TYPE</th>
<th data-quarto-table-cell-role="th">TLC</th>
<th data-quarto-table-cell-role="th">ADMIN</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">FCLASS_TR</th>
<th data-quarto-table-cell-role="th">FCLASS_ID</th>
<th data-quarto-table-cell-role="th">FCLASS_PL</th>
<th data-quarto-table-cell-role="th">FCLASS_GR</th>
<th data-quarto-table-cell-role="th">FCLASS_IT</th>
<th data-quarto-table-cell-role="th">FCLASS_NL</th>
<th data-quarto-table-cell-role="th">FCLASS_SE</th>
<th data-quarto-table-cell-role="th">FCLASS_BD</th>
<th data-quarto-table-cell-role="th">FCLASS_UA</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">143</th>
<td>Admin-0 country</td>
<td>1</td>
<td>2</td>
<td>United Kingdom</td>
<td>GB1</td>
<td>1</td>
<td>2</td>
<td>Country</td>
<td>1</td>
<td>United Kingdom</td>
<td>...</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>MULTIPOLYGON (((124122.565 449434, 76073.084 4...</td>
</tr>
</tbody>
</table>

<p>1 rows × 169 columns</p>
</div>
</div>
</div>
</section>
<section id="keep-only-great-britain-approximate-longitude-filter" class="level2">
<h2 class="anchored" data-anchor-id="keep-only-great-britain-approximate-longitude-filter">Keep only Great Britain (approximate longitude filter)</h2>
<div id="38344545" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>uk_gb <span class="op">=</span> uk[uk.geometry.centroid.x <span class="op">&gt;</span> <span class="op">-</span><span class="dv">8</span>]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>uk_gb_bng <span class="op">=</span> uk_gb.to_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\morri\AppData\Local\Temp\ipykernel_23992\2014797042.py:1: UserWarning:

Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

</code></pre>
</div>
</div>
<hr>
<div id="538f4cc1" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>geometry <span class="op">=</span> [</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    Point(lon, lat)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lon, lat <span class="kw">in</span> <span class="bu">zip</span>(df[<span class="st">"longitude"</span>], df[<span class="st">"latitude"</span>])</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gpd.GeoDataFrame(df, geometry<span class="op">=</span>geometry, crs<span class="op">=</span><span class="st">"EPSG:4326"</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>gdf_bng <span class="op">=</span> gdf.to_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>gdf_bng.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">spatial_risk</th>
<th data-quarto-table-cell-role="th">event</th>
<th data-quarto-table-cell-role="th">lat_bin</th>
<th data-quarto-table-cell-role="th">lon_bin</th>
<th data-quarto-table-cell-role="th">spatial_cell</th>
<th data-quarto-table-cell-role="th">smoothed_event_rate</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>53.830581</td>
<td>-4.868714</td>
<td>0.006423</td>
<td>0</td>
<td>215</td>
<td>-19</td>
<td>215_-19</td>
<td>0.014652</td>
<td>POINT (211310.296 440963.865)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>51.573766</td>
<td>-1.235600</td>
<td>0.195246</td>
<td>0</td>
<td>206</td>
<td>-4</td>
<td>206_-4</td>
<td>0.027660</td>
<td>POINT (453071.279 186376.537)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>51.247683</td>
<td>-2.048911</td>
<td>0.099452</td>
<td>0</td>
<td>204</td>
<td>-8</td>
<td>204_-8</td>
<td>0.041006</td>
<td>POINT (396682.661 149835.711)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>53.032231</td>
<td>-0.370855</td>
<td>0.092219</td>
<td>0</td>
<td>212</td>
<td>-1</td>
<td>212_-1</td>
<td>0.028019</td>
<td>POINT (509347.525 349568.357)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>53.957079</td>
<td>-2.130276</td>
<td>0.387473</td>
<td>0</td>
<td>215</td>
<td>-8</td>
<td>215_-8</td>
<td>0.028388</td>
<td>POINT (391549.07 451228.895)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
<div id="632fd98e" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">10</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set subtle background colour</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>ax.set_facecolor(<span class="st">"#f0f0f0"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot spatial risk points first</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>gdf_bng.plot(</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"smoothed_event_rate"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"viridis"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    markersize<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot GB boundary ON TOP as white outline</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>uk_gb_bng.plot(</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">1.5</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Smoothed Spatial Risk (British National Grid, Great Britain)"</span>)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Easting (m)"</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Northing (m)"</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="geospatial-risk_files/figure-html/cell-17-output-1.png" width="650" height="816" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Country boundaries are sourced from Natural Earth (public domain) and projected into the British National Grid (EPSG:27700). Northern Ireland is excluded due to its use of a separate national grid reference system.</p>
<hr>
</section>
<section id="wip---visualisation" class="level2">
<h2 class="anchored" data-anchor-id="wip---visualisation">WIP - Visualisation</h2>
<hr>
<div id="f9f627cc" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>lsoa <span class="op">=</span> gpd.read_file(<span class="vs">r"C:</span><span class="er">\</span><span class="vs">Users</span><span class="dv">\m</span><span class="vs">orri</span><span class="er">\</span><span class="vs">PycharmProjects</span><span class="dv">\s</span><span class="vs">hmers</span><span class="dv">.</span><span class="vs">github</span><span class="dv">.</span><span class="vs">io</span><span class="er">\</span><span class="vs">geodata</span><span class="er">\</span><span class="vs">Lower_layer_Super_Output_Areas_December_2021_Boundaries_EW_BGC_V5_-6970154227154374572</span><span class="dv">.</span><span class="vs">gpkg"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>lsoa.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LSOA21CD</th>
<th data-quarto-table-cell-role="th">LSOA21NM</th>
<th data-quarto-table-cell-role="th">LSOA21NMW</th>
<th data-quarto-table-cell-role="th">BNG_E</th>
<th data-quarto-table-cell-role="th">BNG_N</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">LONG</th>
<th data-quarto-table-cell-role="th">GlobalID</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>E01000001</td>
<td>City of London 001A</td>
<td></td>
<td>532123</td>
<td>181632</td>
<td>51.518169</td>
<td>-0.097150</td>
<td>{86214465-5CF4-4E8F-9492-3667471C42D6}</td>
<td>MULTIPOLYGON (((532105.312 182010.574, 532104....</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>E01000002</td>
<td>City of London 001B</td>
<td></td>
<td>532480</td>
<td>181715</td>
<td>51.518829</td>
<td>-0.091970</td>
<td>{CD40C491-6567-405F-8C18-426E17B356CE}</td>
<td>MULTIPOLYGON (((532634.497 181926.016, 532572....</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>E01000003</td>
<td>City of London 001C</td>
<td></td>
<td>532239</td>
<td>182033</td>
<td>51.521740</td>
<td>-0.095330</td>
<td>{7FD27AAF-D858-4E46-9099-92B43F66B948}</td>
<td>MULTIPOLYGON (((532135.138 182198.131, 532071....</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>E01000005</td>
<td>City of London 001E</td>
<td></td>
<td>533581</td>
<td>181283</td>
<td>51.514690</td>
<td>-0.076280</td>
<td>{7E76A16A-028F-4F49-84B5-6E5A67322F3C}</td>
<td>MULTIPOLYGON (((533808.018 180767.774, 533842....</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>E01000006</td>
<td>Barking and Dagenham 016A</td>
<td></td>
<td>544994</td>
<td>184274</td>
<td>51.538750</td>
<td>0.089317</td>
<td>{25AB047E-6FCF-4F76-9176-E92E44C0E097}</td>
<td>MULTIPOLYGON (((545122.049 184314.931, 545118....</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="reproject-to-bng" class="level2">
<h2 class="anchored" data-anchor-id="reproject-to-bng">Reproject to BNG</h2>
<div id="cd24bee9" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>lsoa_bng <span class="op">=</span> lsoa.to_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>lsoa_bng.crs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>&lt;Projected CRS: EPSG:27700&gt;
Name: OSGB36 / British National Grid
Axis Info [cartesian]:
- E[east]: Easting (metre)
- N[north]: Northing (metre)
Area of Use:
- name: United Kingdom (UK) - offshore to boundary of UKCS within 49°45'N to 61°N and 9°W to 2°E; onshore Great Britain (England, Wales and Scotland). Isle of Man onshore.
- bounds: (-9.01, 49.75, 2.01, 61.01)
Coordinate Operation:
- name: British National Grid
- method: Transverse Mercator
Datum: Ordnance Survey of Great Britain 1936
- Ellipsoid: Airy 1830
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<hr>
<p>LSOA boundary data are sourced from the UK Office for National Statistics Open Geography Portal and stored locally to ensure reproducibility. This avoids reliance on unstable external URLs while preserving authoritative geography under the Open Government Licence.</p>
<hr>
</section>
<section id="load-population-csv" class="level2">
<h2 class="anchored" data-anchor-id="load-population-csv">Load population CSV</h2>
<div id="77a45d59" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pop <span class="op">=</span> pd.read_csv(<span class="vs">r"C:</span><span class="er">\</span><span class="vs">Users</span><span class="dv">\m</span><span class="vs">orri</span><span class="er">\</span><span class="vs">PycharmProjects</span><span class="dv">\s</span><span class="vs">hmers</span><span class="dv">.</span><span class="vs">github</span><span class="dv">.</span><span class="vs">io</span><span class="er">\</span><span class="vs">geodata</span><span class="dv">\M</span><span class="vs">id 2022 LSOA 2021</span><span class="dv">.</span><span class="vs">csv"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pop.columns.tolist())</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>pop.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['LAD 2023 Code', 'LAD 2023 Name', 'LSOA 2021 Code', 'LSOA 2021 Name', 'Total', 'F0 to 15', 'F16 to 29', 'F30 to 44', 'F45 to 64', 'F65 and over', 'M0 to 15', 'M16 to 29', 'M30 to 44', 'M45 to 64', 'M65 and over']</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LAD 2023 Code</th>
<th data-quarto-table-cell-role="th">LAD 2023 Name</th>
<th data-quarto-table-cell-role="th">LSOA 2021 Code</th>
<th data-quarto-table-cell-role="th">LSOA 2021 Name</th>
<th data-quarto-table-cell-role="th">Total</th>
<th data-quarto-table-cell-role="th">F0 to 15</th>
<th data-quarto-table-cell-role="th">F16 to 29</th>
<th data-quarto-table-cell-role="th">F30 to 44</th>
<th data-quarto-table-cell-role="th">F45 to 64</th>
<th data-quarto-table-cell-role="th">F65 and over</th>
<th data-quarto-table-cell-role="th">M0 to 15</th>
<th data-quarto-table-cell-role="th">M16 to 29</th>
<th data-quarto-table-cell-role="th">M30 to 44</th>
<th data-quarto-table-cell-role="th">M45 to 64</th>
<th data-quarto-table-cell-role="th">M65 and over</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>E06000001</td>
<td>Hartlepool</td>
<td>E01011949</td>
<td>Hartlepool 009A</td>
<td>1,876</td>
<td>182</td>
<td>166</td>
<td>189</td>
<td>274</td>
<td>179</td>
<td>189</td>
<td>181</td>
<td>152</td>
<td>236</td>
<td>128</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>E06000001</td>
<td>Hartlepool</td>
<td>E01011950</td>
<td>Hartlepool 008A</td>
<td>1,117</td>
<td>96</td>
<td>79</td>
<td>102</td>
<td>147</td>
<td>99</td>
<td>104</td>
<td>92</td>
<td>138</td>
<td>175</td>
<td>85</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>E06000001</td>
<td>Hartlepool</td>
<td>E01011951</td>
<td>Hartlepool 007A</td>
<td>1,260</td>
<td>90</td>
<td>126</td>
<td>139</td>
<td>170</td>
<td>90</td>
<td>133</td>
<td>100</td>
<td>146</td>
<td>189</td>
<td>77</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>E06000001</td>
<td>Hartlepool</td>
<td>E01011952</td>
<td>Hartlepool 002A</td>
<td>1,635</td>
<td>193</td>
<td>134</td>
<td>156</td>
<td>207</td>
<td>196</td>
<td>194</td>
<td>109</td>
<td>104</td>
<td>202</td>
<td>140</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>E06000001</td>
<td>Hartlepool</td>
<td>E01011953</td>
<td>Hartlepool 002B</td>
<td>1,984</td>
<td>216</td>
<td>220</td>
<td>190</td>
<td>231</td>
<td>145</td>
<td>290</td>
<td>177</td>
<td>160</td>
<td>232</td>
<td>123</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="extract-relevant-columns" class="level2">
<h2 class="anchored" data-anchor-id="extract-relevant-columns">Extract relevant columns</h2>
<div id="0895634d" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pop <span class="op">=</span> pop.rename(columns<span class="op">=</span>{</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"LSOA 2021 Code"</span>: <span class="st">"LSOA21CD"</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Total"</span>: <span class="st">"population"</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>pop <span class="op">=</span> pop[[<span class="st">"LSOA21CD"</span>, <span class="st">"population"</span>]]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>pop.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LSOA21CD</th>
<th data-quarto-table-cell-role="th">population</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>E01011949</td>
<td>1,876</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>E01011950</td>
<td>1,117</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>E01011951</td>
<td>1,260</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>E01011952</td>
<td>1,635</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>E01011953</td>
<td>1,984</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="dd41e5e4" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>pop[<span class="st">"population"</span>] <span class="op">=</span> (</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    pop[<span class="st">"population"</span>]</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">","</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    .astype(<span class="bu">int</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>pop.dtypes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>LSOA21CD      object
population     int64
dtype: object</code></pre>
</div>
</div>
<div id="f575f5c1" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>lsoa <span class="op">=</span> lsoa.merge(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    pop,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"LSOA21CD"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>lsoa[<span class="st">"population"</span>].isna().mean()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>np.float64(0.0)</code></pre>
</div>
</div>
<hr>
</section>
<section id="project-compute-population-density" class="level2">
<h2 class="anchored" data-anchor-id="project-compute-population-density">## Project &amp; Compute Population Density</h2>
<div id="b62af677" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>lsoa_bng <span class="op">=</span> lsoa.to_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>lsoa_bng[<span class="st">"area_km2"</span>] <span class="op">=</span> lsoa_bng.geometry.area <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>lsoa_bng[<span class="st">"pop_density"</span>] <span class="op">=</span> (</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    lsoa_bng[<span class="st">"population"</span>] <span class="op">/</span> lsoa_bng[<span class="st">"area_km2"</span>]</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4ed510dd" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">11</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>ax.set_facecolor(<span class="st">"#f0f0f0"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>lsoa_bng.plot(</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"pop_density"</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"viridis"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>{</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>: <span class="st">"Population density (people per km²)"</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shrink"</span>: <span class="fl">0.6</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Population Density by LSOA (Great Britain)"</span>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="geospatial-risk_files/figure-html/cell-25-output-1.png" width="691" height="649" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>